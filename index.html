import React, { useState, useEffect } from 'react';
import { 
  Plus, 
  Trash2, 
  Package, 
  ArrowLeftRight, 
  Tag, 
  Save, 
  RotateCcw, 
  CheckCircle2,
  ChevronRight, 
  ChevronLeft, 
  Barcode, 
  Cpu, 
  MapPin, 
  ClipboardList, 
  Truck, 
  Box, 
  Hash, 
  X, 
  ArrowRight, 
  Activity 
} from 'lucide-react';

// --- KOMPONEN LOGO PROFESIONAL ---
const ProLogo = ({ light = false }) => (
  <div className="flex items-center gap-3">
    <div className={`relative flex items-center justify-center w-10 h-10 md:w-11 md:h-11 rounded-lg ${light ? 'bg-white text-slate-900' : 'bg-slate-900 text-white'} shadow-sm`}>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="w-6 h-6" strokeLinecap="round" strokeLinejoin="round">
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
        <polyline points="9 22 9 12 15 12 15 22" />
      </svg>
      <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></div>
    </div>
    <div className="flex flex-col text-left">
      <span className={`text-lg font-bold tracking-tight leading-none ${light ? 'text-white' : 'text-slate-800'}`}>MV-LOGISTIK</span>
      <span className={`text-[10px] font-semibold tracking-[0.15em] uppercase ${light ? 'text-blue-200' : 'text-blue-600'}`}>Solusi Inventaris Terpadu</span>
    </div>
  </div>
);

// --- KOMPONEN FOOTER GLOBAL ---
const GlobalFooter = () => (
  <footer className="mt-12 mb-8 text-center animate-in fade-in duration-1000">
    <div className="inline-flex flex-col items-center gap-2">
      <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em]">
        Manajemen Inventaris Microvision
      </p>
      <div className="flex items-center gap-2">
        <span className="h-[1px] w-4 bg-slate-200"></span>
        <span className="text-[9px] font-semibold text-slate-400 uppercase tracking-widest bg-white border border-slate-100 px-3 py-1 rounded-full">
          Versi 1.7.5
        </span>
        <span className="h-[1px] w-4 bg-slate-200"></span>
      </div>
    </div>
  </footer>
);

// --- DATA TAKSONOMI PRODUK ---
const PRODUCT_TAXONOMY = {
  // --- KATEGORI UNIT (PG-UNIT) ---
  'MVIFCI': { 
    type: 'UNIT', 
    isBatchMode: true,
    models: { 'Standard': ['P1.86', 'P2.50', 'P4.00'] } 
  },
  'MVIDCI': { 
    type: 'UNIT', 
    isBatchMode: true,
    models: { 'Standard': ['P1.86', 'P1.50', 'P2.00', 'P2.50'] } 
  },
  'MVIFCO': { 
    type: 'UNIT', 
    isBatchMode: true,
    models: { 'Standard': ['P4.00', 'P5.00', 'P6.00', 'P8.00', 'P10.00'] } 
  },
  'KIOSK': { 
    type: 'UNIT', 
    isLockedQty: true, 
    models: { 'SLIM': [], 'Standard': [] } 
  },
  'IFP': { 
    type: 'UNIT', 
    isLockedQty: true, 
    models: { 
      'MICROVISION': ['65"', '75"', '86"'], 
      'NEWLINE': ['65"', '75"', '86"'], 
      'PHILIPS': ['65"', '75"', '86"'] 
    } 
  },
  'VDW': { 
    type: 'UNIT', 
    isLockedQty: true, 
    models: { 
      'MICROVISION': ['4935', '5535', '5517', '5588'], 
      'PHILIPS': ['49BDL2105X-ik', '55BDL2105X-ik'] 
    } 
  },

  // --- KATEGORI PART (PG-PART) ---
  'Module': { 
    type: 'PART', 
    needsModuleBatch: true, // Menandakan butuh kolom Batch tambahan setelah Model
    models: { 
      'MVIMDI3218': ['P1.86', 'P1.50', 'P2.00', 'P2.50'], 
      'MVIMDI1616': ['P2.50'], 
      'MVIMDI3216': ['P1.86', 'P2.50', 'P4.00'], 
      'MVIDI3216': ['P2.50'], 
      'MVIMDO3216': ['P4.00', 'P5.00', 'P6.00', 'P8.00', 'P10.00'] 
    } 
  },
  'Receiving Card': { type: 'PART', models: { 'MRV416': [], 'MRV432': [], 'MRV532': [] } },
  'Power Supply': { type: 'PART', models: { 'FPSU40A': [], 'PSU40A': [], 'PSU60A': [] } },
  'Kabel': { type: 'PART', models: { 'LAN': ['LAN1.0', 'LAN1.5', 'LAN2.0'], 'FLAT': ['20 CM', '50 CM', '70 CM', '80 CM'], 'POWER': ['5V TO MODULE', '73 CM DCI', '58 CM DCI2.5'] } },
  'Sparepart': { type: 'PART', models: { 'IC-MDL': [], 'LED-LAMP': [], 'FACE MASK': [] } },
  'Baut': { type: 'PART', models: { 'MAGNET': [], 'SCREW MDL': [] } },
  'Konektor': { type: 'PART', models: { 'CONNECTOR': [], 'TRAY': [], 'PCS': [] } },
  'Bracket': { type: 'PART', models: { 'MVICCIL': [], 'FRAME 640X480': [], 'STAND KIOSK': [] } },
  'Karet': { type: 'PART', models: { 'RING WTR-PRF': [] } },
  'Kardus': { type: 'PART', models: { 'KARDUS DCI': [] } },
  'Pallet': { type: 'PART', models: { 'PALLET FCO': [] } }
};

const App = () => {
  const [isLanding, setIsLanding] = useState(true);
  const [activeTab, setActiveTab] = useState('logistics');
  const [showSuccess, setShowSuccess] = useState(false);
  const [pgType, setPgType] = useState(null); 
  const [errors, setErrors] = useState({});
  
  const [formData, setFormData] = useState({
    pgNumber: '',
    date: new Date().toISOString().split('T')[0],
    originWarehouse: '', 
    destinationWarehouse: '', 
    category: '',
    model: '', 
    batch: '', // State baru untuk Batch Module Part
    specification: '',
    productName: '',
    quantity: 1,
    unit: 'Unit',
    pic: '',
    notes: '',
    rawSN: '' 
  });

  const handleStartMutasi = (type) => {
    setPgType(type);
    setIsLanding(false);
    setActiveTab('logistics');
    
    const year = new Date().getFullYear();
    const rand = Math.floor(1000 + Math.random() * 9000);
    setFormData(prev => ({ 
      ...prev, 
      pgNumber: `PG/${type}/${year}/${rand}`,
      category: '',
      model: '',
      batch: '',
      specification: '',
      productName: '',
      rawSN: '',
      quantity: 1
    }));
  };

  const handleCategoryChange = (val) => {
    setFormData(prev => ({ 
      ...prev, 
      category: val, 
      model: '', 
      batch: '',
      specification: '', 
      productName: val,
      rawSN: '', 
      quantity: 1,
      unit: pgType === 'UNIT' ? 'Unit' : 'Pcs'
    }));
  };

  const handleModelChange = (val) => {
    const taxonomy = PRODUCT_TAXONOMY[formData.category];
    const isBatchUnit = taxonomy?.isBatchMode;
    const isModulePart = taxonomy?.needsModuleBatch;

    setFormData(prev => {
      let newName = "";
      if (isBatchUnit) {
        newName = `${prev.category}-${val}`;
      } else if (isModulePart) {
        newName = `${prev.category}-${val}`;
      } else {
        newName = `${prev.category} ${val}`;
      }

      return {
        ...prev,
        model: val,
        productName: newName
      };
    });
  };

  const handleBatchChange = (val) => {
    setFormData(prev => ({
      ...prev,
      batch: val,
      productName: prev.specification 
        ? `${prev.category}-${prev.model}-${val}-${prev.specification.startsWith('P') ? prev.specification.substring(1) : prev.specification}`
        : `${prev.category}-${prev.model}-${val}`
    }));
  };

  const handleSpecChange = (val) => {
    setFormData(prev => {
      const taxonomy = PRODUCT_TAXONOMY[prev.category];
      const isBatchUnit = taxonomy?.isBatchMode;
      const isModulePart = taxonomy?.needsModuleBatch;
      const cleanSpec = val.startsWith('P') ? val.substring(1) : val;

      let newName = "";
      if (isBatchUnit) {
        newName = `${prev.category}-${prev.model}-${cleanSpec}`;
      } else if (isModulePart) {
        newName = `${prev.category}-${prev.model}-${prev.batch}-${cleanSpec}`;
      } else {
        newName = `${prev.category} ${prev.model} ${val}`;
      }

      return { 
        ...prev, 
        specification: val, 
        productName: newName 
      };
    });
  };

  const handleSNChange = (val) => {
    const isLocked = PRODUCT_TAXONOMY[formData.category]?.isLockedQty;
    
    if (isLocked) {
      const lines = val.split('\n').filter(line => line.trim() !== '');
      setFormData(prev => ({
        ...prev,
        rawSN: val,
        quantity: lines.length > 0 ? lines.length : 0
      }));
    } else {
      setFormData(prev => ({ ...prev, rawSN: val }));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const newErrors = {};
    if (!formData.pgNumber) newErrors.pgNumber = true;
    if (!formData.originWarehouse) newErrors.originWarehouse = true;
    if (!formData.destinationWarehouse) newErrors.destinationWarehouse = true;
    if (!formData.category) newErrors.category = true;
    if (!formData.model) newErrors.model = true;
    if (PRODUCT_TAXONOMY[formData.category]?.needsModuleBatch && !formData.batch) newErrors.batch = true;
    
    if (Object.keys(newErrors).length > 0) {
      setErrors(newErrors);
      if (newErrors.pgNumber || newErrors.originWarehouse || newErrors.destinationWarehouse) setActiveTab('logistics');
      else setActiveTab('product');
      return;
    }
    
    setShowSuccess(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(() => {
        setShowSuccess(false);
        setIsLanding(true);
        setFormData({
            pgNumber: '',
            date: new Date().toISOString().split('T')[0],
            originWarehouse: '', 
            destinationWarehouse: '', 
            category: '',
            model: '',
            batch: '',
            specification: '',
            productName: '',
            quantity: 1,
            unit: 'Unit',
            pic: '',
            notes: '',
            rawSN: '' 
        });
    }, 2500);
  };

  const currentCategory = PRODUCT_TAXONOMY[formData.category];
  const isBatchUnitMode = currentCategory?.isBatchMode || false;
  const isModulePartMode = currentCategory?.needsModuleBatch || false;
  const isLockedQty = currentCategory?.isLockedQty || false;
  const needsSN = pgType === 'UNIT' && formData.category !== '';

  const TabBtn = ({ id, icon: Icon, label }) => (
    <button
      type="button"
      onClick={() => setActiveTab(id)}
      className={`flex-shrink-0 flex items-center gap-2.5 px-6 py-4 border-b-2 transition-all text-sm font-medium ${
        activeTab === id ? 'border-blue-600 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'
      }`}
    >
      <Icon size={16} /> {label}
    </button>
  );

  // --- HALAMAN LANDING ---
  if (isLanding) {
    return (
      <div className="min-h-screen bg-[#f1f5f9] flex items-center justify-center p-6 flex-col">
        <div className="max-w-4xl w-full">
          <div className="text-center mb-16 animate-in fade-in zoom-in duration-700">
            <div className="flex justify-center mb-6">
              <ProLogo />
            </div>
            <h1 className="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight mb-3 text-balance">Sistem Manajemen Logistik</h1>
            <p className="text-slate-500 font-medium italic">Silakan pilih jenis dokumen mutasi untuk memulai transaksi</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in slide-in-from-bottom-10 duration-1000">
            <button 
              onClick={() => handleStartMutasi('UNIT')}
              className="group bg-white p-8 rounded-2xl border border-slate-200 hover:border-blue-400 hover:shadow-xl hover:shadow-blue-500/5 transition-all text-left flex flex-col items-start gap-6"
            >
              <div className="w-14 h-14 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                <Box size={28} />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-slate-900">PG-UNIT</h2>
                <p className="text-slate-500 mt-2 text-sm leading-relaxed font-medium">Mutasi unit Rakitan & Monitor (MVIFCI, MVIDCI, MVIFCO, Kiosk, IFP, VDW).</p>
              </div>
              <div className="mt-auto flex items-center text-blue-600 font-bold text-sm gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                Mulai Transaksi Unit <ArrowRight size={18} />
              </div>
            </button>

            <button 
              onClick={() => handleStartMutasi('PART')}
              className="group bg-white p-8 rounded-2xl border border-slate-200 hover:border-slate-800 hover:shadow-xl transition-all text-left flex flex-col items-start gap-6"
            >
              <div className="w-14 h-14 bg-slate-100 text-slate-600 rounded-xl flex items-center justify-center group-hover:bg-slate-900 group-hover:text-white transition-all shadow-sm">
                <Cpu size={28} />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-slate-900">PG-PART</h2>
                <p className="text-slate-500 mt-2 text-sm leading-relaxed font-medium">Mutasi suku cadang LED, kabel, PSU, modul, dan aksesoris lainnya.</p>
              </div>
              <div className="mt-auto flex items-center text-slate-900 font-bold text-sm gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                Mulai Transaksi Part <ArrowRight size={18} />
              </div>
            </button>
          </div>
        </div>
        <GlobalFooter />
      </div>
    );
  }

  // --- HALAMAN FORM ---
  return (
    <div className="min-h-screen bg-[#f8fafc] pb-10 flex flex-col text-left">
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 shadow-sm">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div className="cursor-pointer" onClick={() => setIsLanding(true)}>
            <ProLogo />
          </div>
          <div className="flex items-center gap-3">
            <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
              <button 
                onClick={() => handleStartMutasi('UNIT')}
                className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${pgType === 'UNIT' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
              >
                PG-UNIT
              </button>
              <button 
                onClick={() => handleStartMutasi('PART')}
                className={`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${pgType === 'PART' ? 'bg-slate-900 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
              >
                PG-PART
              </button>
            </div>
            <button onClick={handleSubmit} className="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
              <Save size={16}/> Terbitkan Dokumen
            </button>
          </div>
        </div>
      </nav>

      <div className="max-w-5xl mx-auto px-4 md:px-6 pt-8 flex-grow text-slate-700">
        {showSuccess && (
          <div className="mb-6 p-4 bg-emerald-500 text-white rounded-xl flex items-center gap-4 animate-in slide-in-from-top-4 shadow-lg border border-emerald-400">
            <CheckCircle2 size={24}/>
            <div className="text-sm text-left">
              <p className="font-bold">Transaksi Berhasil!</p>
              <p className="opacity-90 font-medium">Dokumen mutasi {formData.pgNumber} telah dijana dalam pangkalan data.</p>
            </div>
          </div>
        )}

        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
          <div className="flex border-b bg-slate-50/30 overflow-x-auto scrollbar-hide">
            <TabBtn id="logistics" icon={Truck} label="Logistik" />
            <TabBtn id="product" icon={Package} label="Detail Barang" />
            <TabBtn id="notes" icon={ClipboardList} label="Catatan Akhir" />
          </div>

          <div className="p-6 md:p-8">
            <form onSubmit={handleSubmit}>
              
              {/* TAB 1: LOGISTIK */}
              {activeTab === 'logistics' && (
                <div className="space-y-8 animate-in fade-in duration-300">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-1.5 text-left">
                      <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wide">No-PG</label>
                      <div className="relative">
                        <Barcode className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                        <input 
                          type="text" 
                          placeholder="Ketik No-PG manual..."
                          className={`w-full p-3.5 pl-11 bg-white rounded-xl border transition-all font-mono font-bold text-blue-600 outline-none ${errors.pgNumber ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'}`}
                          value={formData.pgNumber} 
                          onChange={(e) => setFormData(p => ({ ...p, pgNumber: e.target.value }))}
                        />
                      </div>
                    </div>
                    <div className="space-y-1.5 text-left">
                      <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Tanggal</label>
                      <input type="date" value={formData.date} onChange={(e) => setFormData(p => ({ ...p, date: e.target.value }))} className="w-full p-3.5 rounded-xl border border-slate-200 font-semibold outline-none focus:border-blue-500" />
                    </div>
                  </div>

                  <div className="bg-slate-50/50 p-6 md:p-8 rounded-2xl border border-slate-200 relative">
                    <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full border border-slate-200 flex items-center justify-center text-blue-600 hidden md:flex z-10 shadow-sm">
                      <ArrowLeftRight size={18} />
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                      <div className="space-y-2">
                        <label className="flex items-center gap-2 text-[11px] font-bold text-slate-500 uppercase tracking-wide"><MapPin size={14} className="text-red-500"/> Gudang Asal</label>
                        <input 
                          type="text"
                          placeholder="Masukkan nama gudang asal..."
                          className={`w-full p-3.5 bg-white rounded-xl border transition-all font-medium outline-none ${errors.originWarehouse ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'}`}
                          value={formData.originWarehouse}
                          onChange={(e) => setFormData(p => ({ ...p, originWarehouse: e.target.value }))}
                        />
                      </div>

                      <div className="space-y-2">
                        <label className="flex items-center gap-2 text-[11px] font-bold text-slate-500 uppercase tracking-wide"><MapPin size={14} className="text-emerald-500"/> Gudang Destinasi</label>
                        <input 
                          type="text"
                          placeholder="Masukkan gudang tujuan..."
                          className={`w-full p-3.5 bg-white rounded-xl border transition-all font-medium outline-none ${errors.destinationWarehouse ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'}`}
                          value={formData.destinationWarehouse}
                          onChange={(e) => setFormData(p => ({ ...p, destinationWarehouse: e.target.value }))}
                        />
                      </div>
                    </div>
                  </div>

                  <div className="flex justify-end pt-4">
                    <button type="button" onClick={() => setActiveTab('product')} className="px-8 py-3.5 bg-slate-900 text-white rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-black transition-all shadow-lg">
                      Lanjut ke Produk <ChevronRight size={18}/>
                    </button>
                  </div>
                </div>
              )}

              {/* TAB 2: PRODUCT DETAIL */}
              {activeTab === 'product' && (
                <div className="space-y-8 animate-in fade-in duration-300">
                  <div className={`grid grid-cols-1 ${isModulePartMode ? 'md:grid-cols-4' : 'md:grid-cols-3'} gap-6 text-left`}>
                    <div className="space-y-2">
                      <label className="text-[11px] font-bold text-slate-500 uppercase">Kategori</label>
                      <select 
                        className={`w-full p-3.5 rounded-xl border bg-white font-medium outline-none ${errors.category ? 'border-red-400' : 'border-slate-200 focus:border-blue-500'}`}
                        value={formData.category}
                        onChange={(e) => handleCategoryChange(e.target.value)}
                      >
                        <option value="">-- Pilih Kategori --</option>
                        {Object.keys(PRODUCT_TAXONOMY).filter(cat => PRODUCT_TAXONOMY[cat].type === pgType).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                      </select>
                    </div>

                    <div className="space-y-2">
                      <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">
                        {isBatchUnitMode ? "Batch" : "Model / Varian"}
                      </label>
                      {isBatchUnitMode ? (
                        <input 
                          type="text"
                          placeholder="Ketik batch manual..."
                          className={`w-full p-3.5 bg-white rounded-xl border transition-all font-medium outline-none ${errors.model ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'}`}
                          value={formData.model}
                          onChange={(e) => handleModelChange(e.target.value)}
                        />
                      ) : (
                        <select 
                          disabled={!formData.category || Object.keys(PRODUCT_TAXONOMY[formData.category]?.models || {}).length === 0}
                          className={`w-full p-3.5 rounded-xl border transition-all font-medium outline-none ${errors.model ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'} disabled:opacity-50 disabled:bg-slate-50`}
                          value={formData.model}
                          onChange={(e) => handleModelChange(e.target.value)}
                        >
                          <option value="">-- {(!formData.category || Object.keys(PRODUCT_TAXONOMY[formData.category]?.models || {}).length === 0) ? 'N/A' : 'Pilih Varian'} --</option>
                          {formData.category && Object.keys(PRODUCT_TAXONOMY[formData.category].models).map(mod => <option key={mod} value={mod}>{mod}</option>)}
                        </select>
                      )}
                    </div>

                    {/* KOLOM BATCH TAMBAHAN KHUSUS MODULE PART */}
                    {isModulePartMode && (
                      <div className="space-y-2 animate-in fade-in duration-300">
                        <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Batch</label>
                        <input 
                          type="text"
                          placeholder="Ketik batch manual..."
                          className={`w-full p-3.5 bg-white rounded-xl border transition-all font-medium outline-none ${errors.batch ? 'border-red-400 bg-red-50' : 'border-slate-200 focus:border-blue-500'}`}
                          value={formData.batch}
                          onChange={(e) => handleBatchChange(e.target.value)}
                        />
                      </div>
                    )}

                    <div className="space-y-2">
                      <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Sub Varian</label>
                      <select 
                        disabled={!formData.model || (formData.category && !isBatchUnitMode && PRODUCT_TAXONOMY[formData.category].models[formData.model]?.length === 0)}
                        className="w-full p-3.5 rounded-xl border border-slate-200 bg-slate-50 disabled:opacity-50 font-medium outline-none"
                        value={formData.specification}
                        onChange={(e) => handleSpecChange(e.target.value)}
                      >
                        <option value="">-- {isBatchUnitMode || isModulePartMode ? 'Pilih Pitch' : 'Pilih Sub Varian'} --</option>
                        {formData.category && (
                          isBatchUnitMode || isModulePartMode
                            ? PRODUCT_TAXONOMY[formData.category].models[formData.model || 'Standard']?.map(s => <option key={s} value={s}>{s}</option>)
                            : PRODUCT_TAXONOMY[formData.category].models[formData.model]?.map(s => <option key={s} value={s}>{s}</option>)
                        )}
                      </select>
                    </div>
                  </div>

                  <div className="p-5 bg-slate-900 rounded-xl shadow-inner text-left">
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-2 block tracking-widest leading-none">Barang Teridentifikasi</label>
                    <div className="text-white font-semibold text-lg flex items-center gap-3 uppercase">
                      <Box size={20} className="text-blue-400" />
                      {formData.productName || "Menunggu pemilihan barang..."}
                    </div>
                  </div>

                  {needsSN && (
                    <div className="space-y-4 animate-in slide-in-from-top-4 duration-500 text-left">
                      <div className="bg-blue-50/50 p-6 rounded-2xl border border-blue-100 space-y-4">
                        <div className="flex justify-between items-center">
                          <div className="flex items-center gap-2 text-blue-900">
                            <Hash size={18} />
                            <h3 className="font-bold text-sm">Masukan Serial Number (SN)</h3>
                          </div>
                          {isLockedQty && (
                             <span className="text-[10px] font-bold bg-blue-600 text-white px-2 py-1 rounded-md uppercase tracking-wider">Mode Per Unit</span>
                          )}
                        </div>

                        <div className="space-y-2">
                           <textarea 
                             rows={isLockedQty ? 6 : 2}
                             placeholder={isLockedQty ? "Tekan ENTER untuk baris SN berikutnya..." : "Ketik rentang SN (Contoh: 01-10)..."}
                             className="w-full p-4 rounded-xl border border-slate-200 font-mono text-sm focus:border-blue-500 outline-none resize-none shadow-inner bg-white"
                             value={formData.rawSN}
                             onChange={(e) => handleSNChange(e.target.value)}
                           ></textarea>
                           {isLockedQty && (
                             <p className="text-[10px] text-slate-400 font-medium italic">*Jumlah akan terkunci otomatis mengikuti jumlah baris SN yang diisi.</p>
                           )}
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4 max-w-sm">
                        <div className="space-y-2">
                          <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Jumlah</label>
                          <input 
                            type="number" 
                            min="0" 
                            readOnly={isLockedQty}
                            className={`w-full p-3.5 rounded-xl border font-bold text-blue-600 outline-none transition-all ${isLockedQty ? 'bg-slate-50 border-slate-100 cursor-not-allowed opacity-70' : 'border-slate-200'}`} 
                            value={formData.quantity} 
                            onChange={(e) => setFormData(p => ({ ...p, quantity: parseInt(e.target.value) || 0 }))} 
                          />
                        </div>
                        <div className="space-y-2">
                          <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Satuan</label>
                          <select className="w-full p-3.5 rounded-xl border border-slate-200 font-bold outline-none" value={formData.unit} onChange={(e) => setFormData(p => ({ ...p, unit: e.target.value }))}>
                            <option>Unit</option><option>Pcs</option><option>Box</option><option>Roll</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  )}

                  {!needsSN && (
                    <div className="grid grid-cols-2 gap-4 max-w-sm text-left">
                      <div className="space-y-2">
                        <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Jumlah</label>
                        <input type="number" min="1" className="w-full p-3.5 rounded-xl border border-slate-200 font-bold text-blue-600 outline-none" value={formData.quantity} onChange={(e) => setFormData(p => ({ ...p, quantity: parseInt(e.target.value) || 0 }))} />
                      </div>
                      <div className="space-y-2">
                        <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Satuan</label>
                        <select className="w-full p-3.5 rounded-xl border border-slate-200 font-bold outline-none" value={formData.unit} onChange={(e) => setFormData(p => ({ ...p, unit: e.target.value }))}>
                          <option>Unit</option><option>Pcs</option><option>Box</option><option>Roll</option>
                        </select>
                      </div>
                    </div>
                  )}

                  <div className="flex justify-between pt-6 border-t">
                    <button type="button" onClick={() => setActiveTab('logistics')} className="px-6 py-3 border border-slate-200 rounded-xl font-semibold text-sm flex items-center gap-2 hover:bg-slate-50 transition-all">
                      <ChevronLeft size={18}/> Logistik
                    </button>
                    <button type="button" onClick={() => setActiveTab('notes')} className="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm flex items-center gap-2 shadow-xl hover:bg-black transition-all">
                      Lanjut ke Ringkasan <ChevronRight size={18}/>
                    </button>
                  </div>
                </div>
              )}

              {/* TAB 3: NOTES */}
              {activeTab === 'notes' && (
                <div className="space-y-8 animate-in fade-in duration-300">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                    <div className="space-y-6">
                      <div className="space-y-2">
                        <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Petugas Penanggung Jawab (PIC)</label>
                        <input 
                          type="text" 
                          placeholder="Nama lengkap pengelola gudang..."
                          className="w-full p-3.5 rounded-xl border border-slate-200 font-semibold focus:border-blue-500 outline-none transition-all" 
                          value={formData.pic}
                          onChange={(e) => setFormData(p => ({ ...p, pic: e.target.value }))}
                        />
                      </div>
                      
                      <div className="p-6 bg-slate-900 rounded-2xl border-l-4 border-blue-500 text-white space-y-4 shadow-xl">
                        <h4 className="font-bold text-blue-400 text-xs uppercase flex items-center gap-2 tracking-wider leading-none"><Activity size={14}/> Ringkasan Transaksi</h4>
                        <div className="space-y-2.5 text-[13px] font-medium opacity-90">
                          <div className="flex justify-between border-b border-white/10 pb-2"><span>No-PG:</span> <span className="font-mono">{formData.pgNumber}</span></div>
                          <div className="flex justify-between border-b border-white/10 pb-2"><span>Barang:</span> <span className="text-blue-300 font-bold truncate max-w-[200px]">{formData.productName}</span></div>
                          <div className="flex justify-between border-b border-white/10 pb-2"><span>Dari:</span> <span>{formData.originWarehouse || "-"}</span></div>
                          <div className="flex justify-between border-b border-white/10 pb-2"><span>Ke:</span> <span>{formData.destinationWarehouse || "-"}</span></div>
                          <div className="flex justify-between border-b border-white/10 pb-2"><span>Tanggal:</span> <span>{formData.date}</span></div>
                          <div className="flex justify-between pt-2"><span>Total:</span> <span className="text-blue-400 font-bold">{formData.quantity} {formData.unit}</span></div>
                        </div>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <label className="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Catatan Tambahan</label>
                      <textarea 
                        rows="8"
                        className="w-full p-5 rounded-2xl border border-slate-200 focus:border-blue-500 outline-none bg-slate-50/20 font-medium text-sm leading-relaxed transition-all"
                        placeholder="Ketik detail proyek atau kondisi barang..."
                        value={formData.notes}
                        onChange={(e) => setFormData(p => ({ ...p, notes: e.target.value }))}
                      ></textarea>
                    </div>
                  </div>

                  <div className="flex justify-between pt-8 border-t">
                    <button type="button" onClick={() => setActiveTab('product')} className="px-6 py-3 border border-slate-200 rounded-xl font-semibold text-sm flex items-center gap-2 hover:bg-slate-50 transition-all">
                      <ChevronLeft size={18}/> Kembali
                    </button>
                    <button type="submit" className="px-12 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-xl shadow-blue-200 hover:bg-blue-700 hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-3">
                      <Save size={22} /> SIMPAN & TERBITKAN
                    </button>
                  </div>
                </div>
              )}

            </form>
          </div>
        </div>
        <GlobalFooter />
      </div>

      {/* Mobile Sticky Action */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-lg border-t border-slate-200 flex gap-3 z-50">
        <button onClick={() => setIsLanding(true)} className="p-3.5 bg-slate-100 text-slate-500 rounded-xl"><RotateCcw size={20}/></button>
        <button onClick={handleSubmit} className="flex-1 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2">
          <Save size={20}/> Terbitkan PG
        </button>
      </div>
    </div>
  );
};

export default App;
