import React, { useState, useEffect } from 'react';
import { 
  LayoutDashboard, 
  PackagePlus, 
  PackageMinus, 
  ClipboardList, 
  Settings, 
  Save, 
  RefreshCw, 
  FileSpreadsheet,
  Search,
  Filter,
  Trash2,
  Box,
  Cable,
  Cpu,
  Monitor,
  Zap,
  Layers,
  Wind
} from 'lucide-react';

// --- DATA KATALOG BARANG (DATA REF) ---
const ITEM_CATALOG = {
  "Inverter": [
    "TK-INV-SCREEN-NET-CVR-L-AXPERT-SMPL", "TK-INV-RMT-BOX-BOTTOM-AXPERT-SMPL", 
    "TK-INV-TOP-CVR-AXPERT-SMPL", "TK-INV-MOULD-WIRE-CVR-AXPERT-SMPL", 
    "TK-INV-CPCBA-SMPL", "TK-INVERTER INDUCTANCE FIXED INFINISOLAR", 
    "TK-INVERTER SCREEN NET COVER R HAUS", "TK-INVERTER SCREEN NET COVER L HAUS", 
    "TK-INVERTER COMM FIXED PLATE HAUS", "TK-INVERTER COMM COVER HAUS", 
    "TK-INVERTER REMOTE BOX BOTTOM HAUS", "TK-INVERTER BOTTOM INFINI", 
    "TK-INVERTER TOP COVER HAUS", "TK-INVERTER MOULD WIRE COVER HAUS", 
    "TK-INVERTER MOULD REAR PANEL INFINI", "TK-INV-HANGER-SMPL", 
    "TK-PACKAGING INVERTER", "TK-PCB'Y-COMM", "TK-PCB'Y-IND", 
    "TK-CORE-FERRITE-RJ45", "TK-CBL-PARALLEL", "TK-RMT-DISP", 
    "TK-CBL-RJ45-RS232", "TK-AWG22-1500-BLK-RED", "TK-MPCBA-INV-6KW", 
    "TK-INV-IND-FIXED-INFINISOLAR-SMPL", "TK-INV-SCREEN-NET-CVR-R-AXPERT-SMPL"
  ],
  "Kabel": [
    "TK-CLR-CBL-30CM-26PIN", "TK-CLR-CBL-35CM-26PIN", "TK-CONNECTOR", 
    "TK-CLR-CBL-45CM-26PIN", "TK-LAN1.0", "TK-CLR-CBL-55CM-26PIN", 
    "TK-PWR-CBL-58CM-DCI", "2.55V POWER CABLE 73 CM DCI", 
    "TK-COLOR CABLES FLAT", "TK-CLR-CBL-35CM-16PIN", "TK-CLR-CBL-55CM-16PIN", 
    "TK-COLOR CABLE", "TK-CLR-CBL-60CM-26PIN", "TK-CLR-CBL-CON-80CM", 
    "TK-CLR-CBL-CON-50CM", "TK-CLR-CBL-CON-70CM", "TK-5V-PWR-MDL-LKL", 
    "TK-CONNECTOR (TRAY)", "TK-LAN1.5", "TK-5V POWER CABLE", 
    "TK-5V POWER TO MODUL", "TK-LAN2.0", "TK-POWER CABLE", 
    "TK-POWER CARD", "TK-CABLE FLAT"
  ],
  "Kardus": [
    "TK-PACKAGING-55\"-VDW-MVI", "TK-KARDUS DCI", "TK-PACKAGING", 
    "TK-PACKAGING SET KIOSK MVI", "TK-PACKAGING SET SLIM KIOSK MVI", 
    "TK-PACKAGING SET 49\" VDW", "TK-PACKAGING SET 75\" IFP MVI", 
    "TK-PACKAGING SET 49\" VDW PHI", "TK-PACKAGING SET 65\" NEWLINE IFP"
  ],
  "KIOSK": [
    "TK-MV-TK55-SPCC", "TK-STB-SK-MVI", "TK-BS-SK-MVI", 
    "TK-PB-SK-MVI (BACKUP)", "TK-MBA-SK-MV (BACKUP)", "TK-BC-SK-MVI"
  ],
  "Module": [
    "TK-MVIMDI3216-1.86-2412", "TK-MVIMDI3218-2.50-2507", "TK-MVIMDI1616-2.50-0000", 
    "TK-MVIMDI3216-2.50-2402", "TK-MVIMDI3216-1.86-2501", "TK-MVIMDI3216-1.86-2310", 
    "TK-MVIDI3216-2.50-2410", "TK-MVIMDI3216-4.00-2412", "TK-MVIMDI3216-1.86-2405", 
    "TK-MVIMDO3216-5.00-2405", "TK-MVIMDO3216-5.00-2403", "TK-MVIMDO3216-4.00-2511", 
    "TK-MVIMDI1616-2.50-2306", "TK-MVIMDO3216-5.00-2406", "TK-MVIMDO3216-5.00-2310", 
    "TK-MVIMDI3216-2.50-2403", "TK-MVIMDI3218-1.86-0000", "TK-MVIMDO3216-5.00-0000", 
    "TK-MVIMDI3216-1.86-2406", "TK-MVIMDO3216-10.00-2405", "TK-MVIMDI3216-2.50-2512", 
    "TK-MVIMDI3218-1.86-2507", "TK-MVIMDI3216-4.00-2409", "TK-MVIMDO3216-5.00-2404", 
    "TK-MVIMDI3216-4.00-2403", "TK-MVIMDO3216-4.00-2510", "TK-MVIMDI3216-4.00-2311", 
    "TK-MVIMDO3216-10.00-2403", "TK-MVIMDO3216-5.00-2512", "TK-MVIMDI1616-2.50-2311", 
    "TK-MVIMDI1616-2.50-2312", "TK-MVIMDI3218-1.50-0000", "TK-MVIMDI3216-2.50-2407", 
    "TK-MVIMDO3216-8.00-2310", "TK-MVIMDI3216-1.86-0000", "TK-MVIMDO3216-6.67-2310", 
    "TK-MVIMDI3218-1.20-0000", "TK-MVIMDI3216-4.00-0000", "TK-MVIMDI3218-2.00-0000", 
    "TK-MVIMDI1616-2.50-2505", "TK-MVIMDO3216-4.00-2310", "TK-MVIMDI3218-2.50-0000", 
    "TK-MVIMDI3216-4.00-2310", "TK-MVIMDI3216-2.50-2411", "TK-MVIMDI3216-2.50-2406", 
    "TK-MVIMDI3216-2.50-2410", "TK-MVIMDO3216-10.00-0000", "TK-MVIMDO3216-4.00-2512", 
    "TK-MVIMDI1616-2.50-2410", "TK-MVIMDO3216-5.00-2402", "TK-MVIMDO3216-4.00-2411", 
    "TK-MVIMDO3216-10.00-2406", "TK-MVIMDI3216-2.50-2511", "TK-MVIMDI3216-1.86-2411", 
    "TK-MVIMDO3216-5.00-2511", "TK-MVIMDO3216-10.00-2410"
  ],
  "Monitor": ["DN-LCDP-5535-VDW"],
  "PSU": ["TK-PSU40A", "TK-FPSU40A", "TK-PSU60A"],
  "RC": ["TK-MRV532-3218", "TK-MRV432-3218", "TK-MRV416-0000"],
  "Sparepart": [
    "TK-IC-MDL-ODR", "TK-FACE-MASK", "TK-LED-LAMP-MDL-ODR", "TK-CONNECTOR (PCS)", 
    "TK-WTR-PRF-RING", "TK-IC-MDL", "TK-MAGNET", "TK-LED-LAMP-MDL", 
    "TK-SCRW-MDL-ODR", "TK-STICKER TT-75225", "TK-STICKER TT-65225"
  ],
  "VDW": [
    "TK-PACKAGING-55\"-VDW-MVI", "TK-BCV-SK-MVI", "TK-LCDP-4935-VDW", 
    "TK-LCDP-5535-VDW", "TK-LCDP-5517-VDW", "TK-LCDP-5588-VDW", 
    "TK-VDW-BCV-MVI", "TK-PSB-4935-VDW", "TK-PSB-5535-VDW", 
    "TK-PSB-5588-VDW", "TK-PSB-5517-VDW", "TK-MV-4935-VDW", 
    "TK-MV-5535-VDW", "TK-MV-5517-VDW", "TK-MV-5588-VDW", 
    "TK-RC-VDW4935-VDW REAR COVER"
  ],
  "WIP": ["TK-WIP-FCI", "TK-WIP-DCI", "TK-WIP-FCO"],
  "Bracket": [
    "TK-STAND KIOSK CABINET LED 3X2", "TK-STAND KIOSK CABINET LED",
    "TK-FRAME-CCIL-A-640X480", "TK-MVICCIL"
  ],
  "Cabinet": [
    "TK-MVIFCI-SMPL", "TK-MVIFCO-SMPL", "TK-MVIFCIL", "TK-MVIFCIP",
    "TK-MVIFCO", "TK-MVIDCI", "TK-MVIFCI", "TK-MVIDCI New"
  ],
  "Air Purifier": [
    "AIR PURIFIER - DEMO", "TK-PACKAGING AIR PURIFIER"
  ],
  "FCO": ["TK-PALET FCO"],
  "FST": [
    "TK-FST", "TK-VH-IFP", "TK-MV-L4286-FST",
    "TK-VESA HANGING IFP", "TK-VESA HANGING VIDEOWALL"
  ],
  "IFP": [
    "TK-MTPCA-MVQ75", "TK-MTPCA-MVQ86", "TK-BACK ENCLOSURE CASING 65\" NEWLINE",
    "TK-POWER SUPPLY BOARD 75", "TK-POWER SUPPLY BOARD 86",
    "TK-MBA-MVQ75", "TK-MBA-MVQ86", "TK-IFP-BCV-PHI", "TK-IFP-BCV-NL"
  ],
  "Others": []
};

const CATEGORIES = Object.keys(ITEM_CATALOG);

const INITIAL_DATA = [];

export default function App() {
  // --- STATE MANAGEMENT ---
  const [activeTab, setActiveTab] = useState('dashboard');
  const [inventory, setInventory] = useState(INITIAL_DATA);
  const [sheetUrl, setSheetUrl] = useState('');
  const [isSyncing, setIsSyncing] = useState(false);
  const [notification, setNotification] = useState(null);

  // Form States
  const [formData, setFormData] = useState({
    type: 'IN', // IN, OUT, OPNAME
    category: CATEGORIES[0],
    name: '',
    variant: '',
    uom: 'Pcs',
    qty: 0,
    location: '',
    notes: ''
  });

  // Filtered Suggestions State
  const [suggestions, setSuggestions] = useState([]);

  // Load data from LocalStorage on startup
  useEffect(() => {
    const savedData = localStorage.getItem('warehouse_inventory');
    const savedUrl = localStorage.getItem('google_sheet_url');
    if (savedData) setInventory(JSON.parse(savedData));
    if (savedUrl) setSheetUrl(savedUrl);
  }, []);

  // Save data to LocalStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('warehouse_inventory', JSON.stringify(inventory));
  }, [inventory]);

  // Update suggestions when Category changes
  useEffect(() => {
    const catItems = ITEM_CATALOG[formData.category] || [];
    setSuggestions(catItems);
  }, [formData.category]);

  // --- LOGIC FUNCTIONS ---

  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const sendToGoogleSheet = async (dataPayload) => {
    if (!sheetUrl) return; 
    
    setIsSyncing(true);
    try {
      await fetch(sheetUrl, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataPayload)
      });
      console.log("Data dikirim ke sheet");
    } catch (error) {
      console.error("Gagal sync ke sheet", error);
      showNotification("Gagal sinkronisasi ke Google Sheet", "error");
    } finally {
      setIsSyncing(false);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    const newEntry = {
      id: Date.now(),
      date: new Date().toISOString().split('T')[0],
      ...formData,
      qty: parseInt(formData.qty)
    };

    let updatedInventory = [...inventory];
    
    // Logic update stok berdasarkan tipe transaksi
    if (formData.type === 'IN') {
      const existingIndex = updatedInventory.findIndex(item => 
        item.name.toLowerCase() === newEntry.name.toLowerCase() && 
        item.variant.toLowerCase() === newEntry.variant.toLowerCase()
      );

      if (existingIndex >= 0) {
        updatedInventory[existingIndex].stockSystem += newEntry.qty;
        updatedInventory[existingIndex].stockPhysical += newEntry.qty;
        // Update lokasi jika ada input lokasi baru
        if(newEntry.location) updatedInventory[existingIndex].location = newEntry.location;
      } else {
        updatedInventory.push({
          id: newEntry.id,
          date: newEntry.date,
          category: newEntry.category,
          name: newEntry.name,
          variant: newEntry.variant,
          uom: newEntry.uom,
          stockSystem: newEntry.qty,
          stockPhysical: newEntry.qty,
          location: newEntry.location
        });
      }
    } else if (formData.type === 'OUT') {
      const existingIndex = updatedInventory.findIndex(item => 
        item.name.toLowerCase() === newEntry.name.toLowerCase() && 
        item.variant.toLowerCase() === newEntry.variant.toLowerCase()
      );

      if (existingIndex >= 0) {
        if (updatedInventory[existingIndex].stockSystem < newEntry.qty) {
          showNotification("Stok tidak mencukupi!", "error");
          return;
        }
        updatedInventory[existingIndex].stockSystem -= newEntry.qty;
        updatedInventory[existingIndex].stockPhysical -= newEntry.qty;
      } else {
        showNotification("Barang tidak ditemukan di stok!", "error");
        return;
      }
    } else if (formData.type === 'OPNAME') {
       const existingIndex = updatedInventory.findIndex(item => 
        item.name.toLowerCase() === newEntry.name.toLowerCase() && 
        item.variant.toLowerCase() === newEntry.variant.toLowerCase()
      );

      if (existingIndex >= 0) {
        updatedInventory[existingIndex].stockPhysical = newEntry.qty;
      } else {
         updatedInventory.push({
          id: newEntry.id,
          date: newEntry.date,
          category: newEntry.category,
          name: newEntry.name,
          variant: newEntry.variant,
          uom: newEntry.uom,
          stockSystem: 0,
          stockPhysical: newEntry.qty,
          location: newEntry.location
        });
      }
    }

    setInventory(updatedInventory);
    
    sendToGoogleSheet({
      action: formData.type,
      data: newEntry,
      timestamp: new Date().toLocaleString()
    });

    showNotification(`Transaksi ${formData.type} berhasil disimpan!`);
    
    setFormData(prev => ({
      ...prev,
      qty: 0,
      notes: ''
    }));
  };

  const handleSaveUrl = () => {
    localStorage.setItem('google_sheet_url', sheetUrl);
    showNotification("URL Google Sheet tersimpan!");
  };

  const handleClearData = () => {
    if(window.confirm("Apakah Anda yakin ingin menghapus semua data di aplikasi ini? (Data di Google Sheet tidak akan terhapus)")) {
      setInventory([]);
      localStorage.removeItem('warehouse_inventory');
      showNotification("Data lokal berhasil dibersihkan");
    }
  }

  // --- UI COMPONENTS ---

  const StatCard = ({ title, value, color, icon: Icon }) => (
    <div className={`p-4 rounded-xl shadow-sm border border-gray-100 bg-white flex items-center space-x-4`}>
      <div className={`p-3 rounded-lg ${color} text-white`}>
        <Icon size={24} />
      </div>
      <div>
        <p className="text-gray-500 text-sm">{title}</p>
        <h3 className="text-2xl font-bold text-gray-800">{value}</h3>
      </div>
    </div>
  );

  // Helper untuk icon kategori
  const getCategoryIcon = (cat) => {
    if (cat.includes("Inverter") || cat.includes("PSU")) return Zap;
    if (cat.includes("Kabel")) return Cable;
    if (cat.includes("Module") || cat.includes("RC")) return Cpu;
    if (cat.includes("Monitor") || cat.includes("VDW") || cat.includes("KIOSK") || cat.includes("IFP")) return Monitor;
    if (cat.includes("Kardus") || cat.includes("Cabinet") || cat.includes("FCO")) return Box;
    if (cat.includes("Bracket") || cat.includes("FST")) return Layers;
    if (cat.includes("Air")) return Wind;
    return PackagePlus;
  };

  return (
    <div className="min-h-screen bg-gray-50 flex font-sans text-gray-800">
      
      {/* Sidebar */}
      <aside className="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
        <div className="p-6 border-b border-gray-100">
          <div className="flex items-center gap-2 text-blue-600 font-bold text-xl">
            <PackagePlus /> 
            <span>GudangPro</span>
          </div>
          <p className="text-xs text-gray-400 mt-1">Sistem Stock Opname</p>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'dashboard' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
            <LayoutDashboard size={20} />
            <span>Dashboard</span>
          </button>
          <button onClick={() => { setActiveTab('input'); setFormData(p => ({...p, type: 'IN'})); }} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'input' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
            <PackagePlus size={20} />
            <span>Barang Masuk (IN)</span>
          </button>
          <button onClick={() => { setActiveTab('output'); setFormData(p => ({...p, type: 'OUT'})); }} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'output' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
            <PackageMinus size={20} />
            <span>Barang Keluar (OUT)</span>
          </button>
          <button onClick={() => { setActiveTab('opname'); setFormData(p => ({...p, type: 'OPNAME'})); }} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'opname' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
            <ClipboardList size={20} />
            <span>Stock Opname</span>
          </button>
          <button onClick={() => setActiveTab('settings')} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeTab === 'settings' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
            <Settings size={20} />
            <span>Pengaturan</span>
          </button>
        </nav>

        <div className="p-4 border-t border-gray-100">
           <button onClick={handleClearData} className="w-full flex items-center justify-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded">
             <Trash2 size={16}/> Reset Data Lokal
           </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto">
        {/* Header Mobile */}
        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center sticky top-0 z-10">
          <span className="font-bold text-lg">GudangPro</span>
          <div className="flex gap-2">
            <button onClick={() => setActiveTab('dashboard')} className="p-2 bg-gray-100 rounded"><LayoutDashboard size={20}/></button>
            <button onClick={() => setActiveTab('input')} className="p-2 bg-gray-100 rounded"><PackagePlus size={20}/></button>
            <button onClick={() => setActiveTab('opname')} className="p-2 bg-gray-100 rounded"><ClipboardList size={20}/></button>
          </div>
        </div>

        <div className="p-4 md:p-8 max-w-7xl mx-auto">
          
          {/* Notification Toast */}
          {notification && (
            <div className={`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 text-white transform transition-all duration-300 ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
              {notification.message}
            </div>
          )}

          {/* DASHBOARD VIEW */}
          {activeTab === 'dashboard' && (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-gray-800">Ringkasan Gudang</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <StatCard title="Total Item (SKU)" value={inventory.length} color="bg-blue-500" icon={PackagePlus} />
                <StatCard title="Total Stok Fisik" value={inventory.reduce((acc, cur) => acc + cur.stockPhysical, 0)} color="bg-emerald-500" icon={ClipboardList} />
                <StatCard title="Selisih Stok" value={inventory.reduce((acc, cur) => acc + (cur.stockSystem - cur.stockPhysical), 0)} color="bg-orange-500" icon={RefreshCw} />
                <StatCard title="Total Kategori" value={CATEGORIES.length} color="bg-purple-500" icon={Filter} />
              </div>

              {/* Table Inventory */}
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                  <h3 className="font-semibold text-gray-700">Data Stok Aktual</h3>
                  <button onClick={() => alert('Untuk export ke Excel, silakan gunakan Google Sheet yang sudah terhubung.')} className="flex items-center gap-2 text-sm text-green-600 font-medium hover:text-green-700">
                    <FileSpreadsheet size={16} /> Lihat di Google Sheet
                  </button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm">
                    <thead>
                      <tr className="bg-gray-50 text-gray-600 border-b">
                        <th className="p-4">Kategori</th>
                        <th className="p-4">Nama Barang</th>
                        <th className="p-4">Varian</th>
                        <th className="p-4 text-center">Satuan</th>
                        <th className="p-4 text-right">Stok Sistem</th>
                        <th className="p-4 text-right">Fisik (Opname)</th>
                        <th className="p-4 text-right">Selisih</th>
                        <th className="p-4">Lokasi</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {inventory.map((item) => (
                        <tr key={item.id} className="hover:bg-gray-50">
                          <td className="p-4 font-medium text-gray-800">
                            <span className="px-2 py-1 bg-gray-100 rounded text-xs border border-gray-200 mr-2">
                               {item.category.split(' ')[0]}
                            </span>
                          </td>
                          <td className="p-4 font-medium">{item.name}</td>
                          <td className="p-4 text-gray-500">{item.variant}</td>
                          <td className="p-4 text-center text-gray-500">{item.uom}</td>
                          <td className="p-4 text-right font-mono">{item.stockSystem}</td>
                          <td className="p-4 text-right font-mono font-bold text-blue-600">{item.stockPhysical}</td>
                          <td className={`p-4 text-right font-mono font-bold ${(item.stockSystem - item.stockPhysical) !== 0 ? 'text-red-500' : 'text-green-500'}`}>
                            {item.stockPhysical - item.stockSystem}
                          </td>
                          <td className="p-4 text-gray-500">{item.location}</td>
                        </tr>
                      ))}
                      {inventory.length === 0 && (
                        <tr>
                          <td colSpan="8" className="p-12 text-center text-gray-400">
                            <PackagePlus className="mx-auto mb-2 opacity-50" size={40}/>
                            <p>Belum ada data stok. Silakan input barang masuk.</p>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* INPUT / OUTPUT / OPNAME FORMS */}
          {(activeTab === 'input' || activeTab === 'output' || activeTab === 'opname') && (
            <div className="max-w-2xl mx-auto">
              <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                {activeTab === 'input' && <><PackagePlus className="text-blue-500"/> Input Barang Masuk</>}
                {activeTab === 'output' && <><PackageMinus className="text-red-500"/> Input Barang Keluar</>}
                {activeTab === 'opname' && <><ClipboardList className="text-emerald-500"/> Stock Opname (Cek Fisik)</>}
              </h2>

              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <form onSubmit={handleSubmit} className="space-y-4">
                  
                  {/* Category Dropdown */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select 
                      name="category" 
                      value={formData.category} 
                      onChange={handleInputChange}
                      className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-gray-50"
                    >
                      {CATEGORIES.map((cat, idx) => (
                        <option key={idx} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>

                  {/* Nama Barang with Datalist based on Category */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Nama Barang / Kode (Auto-Suggest dari {formData.category})
                    </label>
                    <input 
                      required
                      list="categoryItems"
                      type="text" 
                      name="name"
                      value={formData.name}
                      onChange={handleInputChange}
                      placeholder={`Ketik nama barang ${formData.category}...`}
                      className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    <datalist id="categoryItems">
                      {suggestions.map((item, idx) => (
                        <option key={idx} value={item}/>
                      ))}
                      {/* Juga tampilkan barang yang sudah pernah diinput manual di inventory */}
                      {inventory
                        .filter(i => i.category === formData.category)
                        .map((i, idx) => <option key={`inv-${idx}`} value={i.name}/>)
                      }
                    </datalist>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Varian/Tipe (Opsional)</label>
                      <input 
                        type="text" 
                        name="variant"
                        value={formData.variant}
                        onChange={handleInputChange}
                        placeholder="Merah / 5m / Box Besar"
                        className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Satuan (UOM)</label>
                      <select 
                        name="uom"
                        value={formData.uom}
                        onChange={handleInputChange}
                        className="w-full p-2.5 border border-gray-300 rounded-lg outline-none bg-gray-50"
                      >
                        <option>Pcs</option>
                        <option>Unit</option>
                        <option>Set</option>
                        <option>Box</option>
                        <option>Roll</option>
                        <option>Meter</option>
                        <option>Kg</option>
                        <option>Lusin</option>
                        <option>Pack</option>
                      </select>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {activeTab === 'opname' ? 'Stok Fisik (Hitungan)' : 'Jumlah (Qty)'}
                      </label>
                      <input 
                        required
                        type="number" 
                        min="0"
                        name="qty"
                        value={formData.qty}
                        onChange={handleInputChange}
                        className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Lokasi Rak</label>
                      <input 
                        type="text" 
                        name="location"
                        value={formData.location}
                        onChange={handleInputChange}
                        placeholder="A-01"
                        className="w-full p-2.5 border border-gray-300 rounded-lg outline-none"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                    <textarea 
                      name="notes"
                      rows="2"
                      value={formData.notes}
                      onChange={handleInputChange}
                      placeholder="Catatan tambahan..."
                      className="w-full p-2.5 border border-gray-300 rounded-lg outline-none"
                    ></textarea>
                  </div>

                  <button 
                    type="submit" 
                    disabled={isSyncing}
                    className={`w-full py-3 px-4 rounded-lg font-bold text-white shadow-md transition-transform active:scale-95 flex justify-center items-center gap-2
                      ${activeTab === 'input' ? 'bg-blue-600 hover:bg-blue-700' : 
                        activeTab === 'output' ? 'bg-red-600 hover:bg-red-700' : 
                        'bg-emerald-600 hover:bg-emerald-700'}`}
                  >
                    {isSyncing ? <RefreshCw className="animate-spin"/> : <Save size={20}/>}
                    {isSyncing ? 'Menyimpan...' : 'Simpan Transaksi'}
                  </button>
                  
                  {sheetUrl === '' && (
                    <div className="bg-orange-50 text-orange-600 text-xs p-3 rounded flex gap-2 items-start mt-2">
                      <Settings size={14} className="mt-0.5"/>
                      <p>Peringatan: URL Google Sheet belum diatur. Data hanya tersimpan di browser ini. Masuk ke menu "Pengaturan" untuk menghubungkan.</p>
                    </div>
                  )}
                </form>
              </div>
            </div>
          )}

          {/* SETTINGS VIEW */}
          {activeTab === 'settings' && (
            <div className="max-w-2xl mx-auto space-y-6">
               <h2 className="text-2xl font-bold text-gray-800">Pengaturan Sinkronisasi</h2>
               
               <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                  <label className="block font-medium text-gray-700 mb-2">Google Apps Script Web App URL</label>
                  <p className="text-sm text-gray-500 mb-4">
                    Masukkan URL dari Google Apps Script untuk menyimpan data secara otomatis ke Spreadsheet.
                  </p>
                  
                  <div className="flex gap-2">
                    <input 
                      type="text" 
                      value={sheetUrl}
                      onChange={(e) => setSheetUrl(e.target.value)}
                      placeholder="https://script.google.com/macros/s/..../exec"
                      className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                    />
                    <button 
                      onClick={handleSaveUrl}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700"
                    >
                      Simpan
                    </button>
                  </div>
               </div>

               <div className="bg-blue-50 p-6 rounded-xl border border-blue-100">
                 <h3 className="font-bold text-blue-800 mb-2">Cara Menggunakan:</h3>
                 <ol className="list-decimal list-inside text-sm text-blue-700 space-y-2">
                   <li>Pilih Kategori Barang di menu Input/Stock Opname.</li>
                   <li>Ketik nama barang, sistem akan otomatis menyarankan kode barang (TK-...) yang sesuai dengan kategori tersebut.</li>
                   <li>Isi jumlah dan simpan.</li>
                   <li>Untuk mengaktifkan penyimpanan ke Excel, ikuti panduan Google Apps Script yang diberikan sebelumnya.</li>
                 </ol>
               </div>
            </div>
          )}

        </div>
      </main>
    </div>
  );
}
